<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ülke Fetih Oyunu - Avrupa (AI vs İnsan)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* SVG ülkeleri için varsayılan renkler */
        .fill-gray-700 { fill: #374151; } /* Sahipsiz */
        .fill-blue-500 { fill: #3B82F6; }
        .fill-red-500 { fill: #EF4444; }
        .fill-green-500 { fill: #22C55E; }
        .fill-purple-500 { fill: #A855F7; }
        .fill-yellow-500 { fill: #F59E0B; }
        .fill-indigo-500 { fill: #6366F1; }
        .fill-pink-500 { fill: #EC4899; }
        .fill-teal-500 { fill: #14B8A6; }
        .stroke-gray-800 { stroke: #1F2937; }
        .stroke-yellow-400 { stroke: #FACC15; }
        .stroke-red-400 { stroke: #F87171; }

        /* Butonlar için özel stil (opsiyonel) */
        .game-button {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
        }
        .game-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .game-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-900 text-white font-inter flex flex-col items-center justify-center min-h-screen p-4">
    <div id="root" class="container max-w-4xl mx-auto bg-gray-800 rounded-lg shadow-lg p-6">
        <!-- Oyun içeriği burada JavaScript tarafından render edilecek -->
        <div class="text-center text-xl">Oyun sunucusuna bağlanılıyor...</div>
    </div>

    <!-- Mesaj Modalı (alert() yerine kullanılır) -->
    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <h3 class="text-xl font-bold mb-4 text-yellow-400">Bilgi</h3>
            <p id="modalContent" class="text-gray-200 mb-6"></p>
            <button
                onclick="hideMessageModal()"
                class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-bold game-button"
            >
                Tamam
            </button>
        </div>
    </div>

    <!-- Socket.IO İstemci Kütüphanesi -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>

    <script>
        const socket = io(); // Render'a deploy edildiğinde otomatik olarak doğru URL'ye bağlanır

        let game = null;
        let userId = null; // Bu, Socket.IO session ID'si olacak

        const playerColors = [
            'bg-blue-500', 'bg-red-500', 'bg-green-500', 'bg-purple-500',
            'bg-yellow-500', 'bg-indigo-500', 'bg-pink-500', 'bg-teal-500'
        ];

        // Bu kısım sadece client tarafında SVG'lerin ve isimlerin görünmesi için tutuluyor,
        // asıl doğru komşuluk ve sahiplik bilgisi sunucudan gelecek.
        const initialCountriesData = [
            {'id': 'france', 'name': 'Fransa', 'path': 'M170 100 Q180 80 200 85 L220 70 Q230 65 240 75 L230 110 Q210 140 180 150 Q160 140 150 120 Z'},
            {'id': 'germany', 'name': 'Almanya', 'path': 'M220 70 Q280 60 300 65 L320 90 Q300 120 250 125 Q230 110 220 70 Z'},
            {'id': 'italy', 'name': 'İtalya', 'path': 'M200 150 Q220 130 230 140 L240 190 Q220 200 200 180 Z'},
            {'id': 'spain', 'name': 'İspanya', 'path': 'M100 160 Q140 140 160 150 Q180 180 140 200 Q110 190 90 170 Z'},
            {'id': 'united_kingdom', 'name': 'Birleşik Krallık', 'path': 'M50 50 Q80 40 90 50 L95 70 Q80 80 60 85 Q40 70 50 50 Z'},
            {'id': 'poland', 'name': 'Polonya', 'path': 'M300 65 Q350 55 370 65 L390 100 Q350 120 320 110 Q280 95 300 65 Z'},
            {'id': 'ukraine', 'name': 'Ukrayna', 'path': 'M390 100 Q450 90 480 110 L490 160 Q450 180 400 170 Q370 150 390 100 Z'},
            {'id': 'russia', 'name': 'Rusya', 'path': 'M460 20 Q550 10 580 50 L590 110 Q550 150 500 140 Q470 90 460 20 Z'},
            {'id': 'sweden', 'name': 'İsveç', 'path': 'M280 10 Q320 0 350 10 L360 40 Q320 50 300 40 Z'},
            {'id': 'norway', 'name': 'Norveç', 'path': 'M250 0 Q280 5 290 20 L270 35 Q240 20 250 0 Z'},
            {'id': 'finland', 'name': 'Finlandiya', 'path': 'M330 0 Q380 5 370 30 L360 50 Q320 40 330 0 Z'},
            {'id': 'belgium', 'name': 'Belçika', 'path': 'M185 85 Q200 80 205 88 L195 95 Q180 90 185 85 Z'},
            {'id': 'netherlands', 'name': 'Hollanda', 'path': 'M190 70 Q210 65 215 75 L200 82 Q185 75 190 70 Z'},
            {'id': 'switzerland', 'name': 'İsviçre', 'path': 'M200 125 Q215 120 220 128 L210 135 Q195 130 200 125 Z'},
            {'id': 'austria', 'name': 'Avusturya', 'path': 'M230 130 Q260 120 270 125 L280 140 Q250 150 230 130 Z'},
            {'id': 'czech_republic', 'name': 'Çek Cumhuriyeti', 'path': 'M260 100 Q290 95 300 105 L280 115 Q265 105 260 100 Z'},
            {'id': 'slovakia', 'name': 'Slovakya', 'path': 'M290 110 Q320 105 330 115 L310 125 Q295 118 290 110 Z'},
            {'id': 'hungary', 'name': 'Macaristan', 'path': 'M270 140 Q300 135 310 145 L300 155 Q275 150 270 140 Z'},
            {'id': 'romania', 'name': 'Romanya', 'path': 'M320 120 Q370 115 380 130 L370 150 Q330 155 320 120 Z'},
            {'id': 'bulgaria', 'name': 'Bulgaristan', 'path': 'M330 150 Q360 145 370 155 L350 170 Q335 160 330 150 Z'},
            {'id': 'greece', 'name': 'Yunanistan', 'path': 'M320 170 Q340 165 350 180 L330 195 Q315 185 320 170 Z'},
            {'id': 'turkey', 'name': 'Türkiye', 'path': 'M380 150 Q450 140 480 170 L460 200 Q400 210 380 150 Z'},
            {'id': 'belarus', 'name': 'Belarus', 'path': 'M350 50 Q380 55 390 70 L370 90 Q355 80 350 50 Z'},
            {'id': 'lithuania', 'name': 'Litvanya', 'path': 'M320 40 Q340 35 350 45 L330 55 Q315 48 320 40 Z'},
            {'id': 'latvia', 'name': 'Letonya', 'path': 'M310 20 Q330 15 340 25 L325 35 Q305 28 310 20 Z'},
            {'id': 'estonia', 'name': 'Estonya', 'path': 'M300 0 Q320 0 330 10 L315 20 Q295 10 300 0 Z'},
            {'id': 'portugal', 'name': 'Portekiz', 'path': 'M70 170 Q90 160 100 170 L80 190 Q65 180 70 170 Z'},
            {'id': 'ireland', 'name': 'İrlanda', 'path': 'M30 60 Q45 55 50 65 L40 75 Q25 70 30 60 Z'},
            {'id': 'albania', 'name': 'Arnavutluk', 'path': 'M290 170 Q300 165 305 175 L295 185 Q285 178 290 170 Z'},
            {'id': 'north_macedonia', 'name': 'Kuzey Makedonya', 'path': 'M305 160 Q315 155 320 165 L310 175 Q300 168 305 160 Z'},
            {'id': 'croatia', 'name': 'Hırvatistan', 'path': 'M240 150 Q260 145 270 155 L250 165 Q235 158 240 150 Z'},
            {'id': 'bosnia_herzegovina', 'name': 'Bosna-Hersek', 'path': 'M250 170 Q265 165 270 175 L255 185 Q245 178 250 170 Z'},
            {'id': 'serbia', 'name': 'Sırbistan', 'path': 'M280 160 Q300 155 310 165 L290 175 Q275 168 280 160 Z'},
            {'id': 'moldova', 'name': 'Moldova', 'path': 'M370 110 Q380 105 385 115 L375 125 Q365 118 370 110 Z'},
            {'id': 'slovenia', 'name': 'Slovenya', 'path': 'M225 140 Q230 135 235 142 L230 148 Q220 145 225 140 Z'},
            {'id': 'luxembourg', 'name': 'Lüksemburg', 'path': 'M200 90 Q205 88 208 92 L203 95 Q198 92 200 90 Z'},
            {'id': 'denmark', 'name': 'Danimarka', 'path': 'M250 50 Q260 45 270 50 L260 60 Q245 55 250 50 Z'},
            {'id': 'kosovo', 'name': 'Kosova', 'path': 'M295 180 Q300 178 303 182 L298 185 Q293 182 295 180 Z'},
            {'id': 'montenegro', 'name': 'Karadağ', 'path': 'M280 185 Q285 182 288 187 L283 190 Q278 187 280 185 Z'},
            {'id': 'russia_kaliningrad', 'name': 'Rusya (Kaliningrad)', 'path': 'M300 30 Q305 28 308 32 L303 35 Q298 32 300 30 Z'}
        ];

        // Modalı gösterme/gizleme fonksiyonları
        function showMessageModal(content) {
            const modal = document.getElementById('messageModal');
            document.getElementById('modalContent').innerText = content;
            modal.classList.remove('hidden');
        }

        function hideMessageModal() {
            const modal = document.getElementById('messageModal');
            modal.classList.add('hidden');
        }

        // Socket.IO olay dinleyicileri
        socket.on('connect', () => {
            console.log('Sunucuya bağlandı. SID:', socket.id);
            userId = socket.id; // Socket ID'sini kullanıcı ID'si olarak kullan
        });
        
        // Sunucudan genel mesajlar almak için dinleyici
        socket.on('message', (data) => {
            showMessageModal(data.text);
        });

        socket.on('disconnect', () => {
            console.log('Sunucu bağlantısı kesildi.');
            document.getElementById('root').innerHTML = '<div class="text-center text-xl text-red-500">Sunucu bağlantısı kesildi. Lütfen sayfayı yenileyin.</div>';
        });

        socket.on('game_state_update', (newGame) => {
            game = newGame;
            console.log('Oyun durumu güncellendi:', game);
            renderGame(); // Oyun durumunu DOM'a yansıt
            
            // Mesajları göster
            if (game.messages && game.messages.length > 0) {
                game.messages.forEach(msg => showMessageModal(msg));
            }
        });

        // Ülke tıklama olayları
        function handleCountryClick(countryId) {
            if (!game || !userId) return;

            const currentPlayer = game.players[game.current_player_index];
            const isMyTurn = currentPlayer && currentPlayer.id === userId;

            if (!isMyTurn) {
                showMessageModal("Sıra sizde değil!");
                return;
            }
            // Eğer AI oyuncusunun sırasındaysa insan müdahale edemesin
            if (currentPlayer && currentPlayer.is_ai) {
                showMessageModal("Şu an AI'nin sırası. Lütfen bekleyin.");
                return;
            }

            const clickedCountry = game.countries.find(c => c.id === countryId);
            if (!clickedCountry) return;

            if (game.game_phase === 'selection') {
                socket.emit('select_country', { countryId: countryId });
            } else if (game.game_phase === 'playing') {
                if (clickedCountry.owner_id === userId) {
                    showMessageModal("Kendi ülkenize savaş açamazsınız.");
                    return;
                }
                if (!clickedCountry.owner_id) {
                    showMessageModal("Sahipsiz ülkelere savaş açamazsınız. Sadece komşu düşman ülkelere savaş açabilirsiniz.");
                    return;
                }

                // DÜZELTME: Sunucudan gelen 'countries' verisindeki komşuluk listesini kullan
                // initialCountriesData değil, çünkü o sadece başlangıç verisi.
                const playerOwnedCountries = game.countries.filter(c => c.owner_id === userId);
                const isNeighbor = playerOwnedCountries.some(myCountry =>
                    myCountry.neighbors.includes(countryId)
                );

                if (!isNeighbor) {
                    showMessageModal("Sadece sınır komşusu olan ülkelere savaş açabilirsiniz.");
                    return;
                }
                socket.emit('initiate_war', { targetCountryId: countryId });
            }
        }

        // Taş-Kağıt-Makas seçimi
        function handleRPSChoice(choice) {
            if (!game || !userId) return;
            
            const currentPlayer = game.players[game.current_player_index];
            // Eğer AI oyuncusunun sırasındaysa insan müdahale edemesin
            if (currentPlayer && currentPlayer.is_ai) {
                showMessageModal("Şu an AI'nin sırası. Lütfen bekleyin.");
                return;
            }

            // Sadece savaş katılımcıları RPS yapabilir
            const { attacker_id, defender_id, rps_choices } = game.war_state;
            if (userId !== attacker_id && userId !== defender_id) {
                 showMessageModal("Taş-Kağıt-Makas oyununda değilsiniz.");
                 return;
            }
            if (rps_choices[userId]) {
                 showMessageModal("Zaten bir seçim yaptınız.");
                 return;
            }

            socket.emit('make_rps_move', { choice: choice });
        }

        // DÜZELTME: Pas geçme butonu için yeni fonksiyon
        function handlePassTurn() {
            if (!game || !userId) return;

            const currentPlayer = game.players[game.current_player_index];
            const isMyTurn = currentPlayer && currentPlayer.id === userId;

            if (!isMyTurn) {
                showMessageModal("Sıra sizde değil!");
                return;
            }
            if (currentPlayer && currentPlayer.is_ai) {
                showMessageModal("Şu an AI'nin sırası. Lütfen bekleyin.");
                return;
            }
            if (game.war_state.attacker_id) { // Savaş devam ederken pas geçilemez
                showMessageModal("Savaş devam ederken pas geçemezsiniz. Lütfen Taş-Kağıt-Makas hamlenizi yapın.");
                return;
            }
            socket.emit('pass_turn');
        }


        // Oyuncu rengini alma
        function getPlayerColorClass(playerId) {
            const playerIndex = game.players.findIndex(p => p.id === playerId);
            return playerColors[playerIndex % playerColors.length];
        }

        // Ülke dolgu rengini alma
        function getCountryFillColor(country) {
            if (country.owner_id) {
                return getPlayerColorClass(country.owner_id).replace('bg-', 'fill-');
            }
            return 'fill-gray-700'; // Sahipsiz ülkeler
        }

        // Ülke kenarlık rengini alma
        function getCountryStrokeColor(country) {
            if (game.war_state.target_country_id === country.id) {
                return 'stroke-yellow-400'; // Savaş hedefi
            }
            const currentPlayer = game.players[game.current_player_index];
            const isMyTurn = currentPlayer && currentPlayer.id === userId;
            if (game.game_phase === 'playing' && isMyTurn) {
                const myOwnedCountries = game.countries.filter(c => c.owner_id === userId);
                const isNeighborOfMyCountry = myOwnedCountries.some(myCountry => myCountry.neighbors.includes(country.id));
                if (isNeighborOfMyCountry && country.owner_id && country.owner_id !== userId) {
                    return 'stroke-red-400'; // Saldırılabilir düşman komşu
                }
            }
            return 'stroke-gray-800';
        }

        // Oyun durumunu DOM'a render et
        function renderGame() {
            if (!game) {
                document.getElementById('root').innerHTML = '<div class="text-center text-xl">Oyun yükleniyor...</div>';
                return;
            }

            const currentPlayer = game.players[game.current_player_index];
            const isMyTurn = currentPlayer && currentPlayer.id === userId;

            const currentWar = game.war_state.attacker_id && game.war_state.defender_id && game.war_state.target_country_id;
            const isParticipantInWar = currentWar && (userId === game.war_state.attacker_id || userId === game.war_state.defender_id);
            const attackerName = currentWar ? game.players.find(p => p.id === game.war_state.attacker_id)?.name : '';
            const defenderName = currentWar ? game.players.find(p => p.id === game.war_state.defender_id)?.name : '';
            const targetCountryName = currentWar ? game.countries.find(c => c.id === game.war_state.target_country_id)?.name : '';

            let playerListHtml = game.players.map(player => `
                <div class="p-4 rounded-lg shadow-md ${getPlayerColorClass(player.id)}">
                    <p class="font-bold text-lg">${player.name} ${player.id === userId ? '(Siz)' : ''} ${player.is_ai ? '(Yapay Zeka)' : ''}</p>
                    <p class="text-sm">Ülke Sayısı: ${player.country_ids.length}</p>
                    <p class="text-xs break-all">ID: ${player.id}</p>
                </div>
            `).join('');

            // Harita SVG'sini render ederken initialCountriesData'yı kullan
            // Çünkü bu veri sadece görsel path'leri içerir, sahiplik bilgileri 'game.countries'den gelir
            let mapHtml = initialCountriesData.map(countryData => {
                const actualCountryState = game.countries.find(c => c.id === countryData.id) || countryData; // Server'dan geleni kullan
                return `
                    <path
                        d="${countryData.path}"
                        class="${getCountryFillColor(actualCountryState)} ${getCountryStrokeColor(actualCountryState)} stroke-2 cursor-pointer transition-all duration-200 ease-in-out hover:opacity-80"
                        onclick="handleCountryClick('${countryData.id}')"
                    >
                        <title>${countryData.name} ${actualCountryState.owner_id ? `(${game.players.find(p => p.id === actualCountryState.owner_id)?.name})` : '(Sahipsiz)'}</title>
                    </path>
                `;
            }).join('');


            let warSectionHtml = '';
            if (currentWar) {
                warSectionHtml = `
                    <div class="text-center">
                        <p class="text-lg font-bold mb-2">
                            <span class="${getPlayerColorClass(game.war_state.attacker_id)} px-2 py-1 rounded-md">${attackerName}</span>
                            <span class="mx-2">vs</span>
                            <span class="${getPlayerColorClass(game.war_state.defender_id)} px-2 py-1 rounded-md">${defenderName}</span>
                        </p>
                        <p class="text-md mb-3">Hedef Ülke: <span class="font-semibold text-yellow-200">${targetCountryName}</span></p>
                        <p class="text-xl font-bold mb-4">Skor: ${game.war_state.attacker_score} - ${game.war_state.defender_score}</p>

                        ${isParticipantInWar && !currentPlayer.is_ai ? `
                            <p class="mb-3">Seçiminizi yapın:</p>
                            <div class="flex justify-center gap-4">
                                <button
                                    onclick="handleRPSChoice('rock')"
                                    ${game.war_state.rps_choices[userId] ? 'disabled' : ''}
                                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-bold game-button disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Taş
                                </button>
                                <button
                                    onclick="handleRPSChoice('paper')"
                                    ${game.war_state.rps_choices[userId] ? 'disabled' : ''}
                                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md font-bold game-button disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Kağıt
                                </button>
                                <button
                                    onclick="handleRPSChoice('scissors')"
                                    ${game.war_state.rps_choices[userId] ? 'disabled' : ''}
                                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md font-bold game-button disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Makas
                                </button>
                            </div>
                            ${game.war_state.rps_choices[userId] ? `<p class="mt-3 text-yellow-200">Seçiminiz: ${game.war_state.rps_choices[userId]}. Rakip bekleniyor...</p>` : ''}
                        ` : `
                            <p class="text-lg text-gray-300">Savaş devam ediyor. Sonucu bekleyin.</p>
                            ${isParticipantInWar && currentPlayer.is_ai ? `<p class="mt-3 text-yellow-200">AI'nın hamlesi bekleniyor...</p>` : ''}
                        `}
                    </div>
                `;
            } else {
                warSectionHtml = `
                    <p class="text-lg text-gray-300 text-center">Şu anda bir savaş yok.</p>
                `;
            }

            // Pas Geç butonu sadece oyun aşamasında ve savaş yokken görünür
            const passTurnButtonHtml = `
                <button
                    onclick="handlePassTurn()"
                    ${!(isMyTurn && game.game_phase === 'playing' && !currentWar) ? 'disabled' : ''}
                    class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-md font-bold game-button disabled:opacity-50 disabled:cursor-not-allowed mt-4 w-full"
                >
                    Pas Geç
                </button>
            `;

            document.getElementById('root').innerHTML = `
                <h1 class="text-4xl font-bold text-center mb-6 text-yellow-400">Ülke Fetih Oyunu</h1>

                <div class="mb-4 text-center text-lg">
                    <p class="font-semibold">Oyun Durumu: <span class="text-blue-300">
                        ${game.game_phase === 'selection' ? `Ülke Seçimi (Her oyuncu ${game.selection_count_per_player} ülke seçecek)` : ''}
                        ${game.game_phase === 'playing' ? 'Oyun Devam Ediyor' : ''}
                        ${game.game_phase === 'game_over' ? 'Oyun Bitti' : ''}
                    </span></p>
                    <p class="font-semibold">Sıra: <span class="${getPlayerColorClass(currentPlayer.id)} px-2 py-1 rounded-md">
                        ${currentPlayer.name} ${currentPlayer.id === userId ? '(Siz)' : ''} ${currentPlayer.is_ai ? '(Yapay Zeka)' : ''}
                    </span></p>
                    <p class="text-sm text-gray-400">Kullanıcı Kimliğiniz: <span class="font-mono text-xs">${userId}</span></p>
                </div>

                <!-- Oyuncu Listesi -->
                <div class="mb-6">
                    <h2 class="text-2xl font-semibold mb-3 text-yellow-300">Oyuncular</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        ${playerListHtml}
                    </div>
                </div>

                <!-- Oyun Alanı -->
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- Harita Bölümü -->
                    <div class="md:w-2/3 bg-gray-700 rounded-lg p-4 flex flex-col items-center justify-center">
                        <h2 class="text-2xl font-semibold mb-3 text-yellow-300">Avrupa Haritası</h2>
                        <!-- viewBox, tüm haritanın görünür olmasını sağlayacak şekilde ayarlandı -->
                        <svg viewBox="0 0 600 220" class="w-full h-auto border-2 border-gray-600 rounded-lg">
                            ${mapHtml}
                        </svg>
                        <p class="text-sm text-gray-400 mt-2">Ülke seçmek veya savaş açmak için haritadaki ülkelere tıklayın.</p>
                    </div>

                    <!-- Savaş/Taş-Kağıt-Makas ve Pas Geç Bölümü -->
                    <div class="md:w-1/3 bg-gray-700 rounded-lg p-4 flex flex-col justify-between">
                        <div>
                            <h2 class="text-2xl font-semibold mb-3 text-yellow-300">Savaş Durumu</h2>
                            ${warSectionHtml}
                        </div>
                        ${passTurnButtonHtml}
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
